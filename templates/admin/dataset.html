{% extends "admin/base.html" %}
{% block content %}
<div x-data="datasetManager()" class="text-gray-900 dark:text-gray-100">
  <h1 class="text-2xl font-semibold mb-4">Gestion du Dataset</h1>

  <!-- Statut du Dataset -->
  <div class="bg-white dark:bg-gray-800 rounded shadow p-4 mb-6 text-gray-900 dark:text-gray-100 border border-gray-200 dark:border-gray-700">
    <h2 class="text-lg font-semibold mb-3">Statut du Dataset</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="p-3 border rounded">
        <div class="text-sm text-gray-600">Données Brutes</div>
        <div class="text-lg font-bold" :class="(datasetStatus.raw_data && datasetStatus.raw_data.exists) ? 'text-green-600' : 'text-red-600'">
          <span x-text="(datasetStatus.raw_data && datasetStatus.raw_data.exists) ? '✓ Disponible' : '✗ Manquant'"></span>
        </div>
        <div class="text-xs text-gray-500" x-text="`${(datasetStatus.raw_data && datasetStatus.raw_data.train_images) || 0} train, ${(datasetStatus.raw_data && datasetStatus.raw_data.test_images) || 0} test`"></div>
      </div>
      
      <div class="p-3 border rounded">
        <div class="text-sm text-gray-600">Données Nettoyées</div>
        <div class="text-lg font-bold" :class="(datasetStatus.cleaned_data && datasetStatus.cleaned_data.exists) ? 'text-green-600' : 'text-red-600'">
          <span x-text="(datasetStatus.cleaned_data && datasetStatus.cleaned_data.exists) ? '✓ Disponible' : '✗ Manquant'"></span>
        </div>
        <div class="text-xs text-gray-500" x-text="`${(datasetStatus.cleaned_data && datasetStatus.cleaned_data.train_images) || 0} train, ${(datasetStatus.cleaned_data && datasetStatus.cleaned_data.test_images) || 0} test`"></div>
      </div>
      
      <div class="p-3 border rounded">
        <div class="text-sm text-gray-600">Dataset YOLO</div>
        <div class="text-lg font-bold" :class="(datasetStatus.yolo_dataset && datasetStatus.yolo_dataset.exists) ? 'text-green-600' : 'text-red-600'">
          <span x-text="(datasetStatus.yolo_dataset && datasetStatus.yolo_dataset.exists) ? '✓ Disponible' : '✗ Manquant'"></span>
        </div>
        <div class="text-xs text-gray-500" x-text="`${(datasetStatus.yolo_dataset && datasetStatus.yolo_dataset.train_images) || 0} train, ${(datasetStatus.yolo_dataset && datasetStatus.yolo_dataset.val_images) || 0} val`"></div>
      </div>
      
      <div class="p-3 border rounded">
        <div class="text-sm text-gray-600">Modèle Entraîné</div>
        <div class="text-lg font-bold" :class="(datasetStatus.model && datasetStatus.model.exists) ? 'text-green-600' : 'text-red-600'">
          <span x-text="(datasetStatus.model && datasetStatus.model.exists) ? '✓ Disponible' : '✗ Manquant'"></span>
        </div>
        <div class="text-xs text-gray-500" x-text="(datasetStatus.model && datasetStatus.model.path) || 'Non disponible'"></div>
      </div>
    </div>
  </div>

  <!-- Actions Rapides -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <button 
      @click="resetDataset()"
      :disabled="loading"
      class="p-4 bg-red-500 text-white rounded hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed"
    >
      <div class="text-lg font-semibold">Réinitialiser</div>
      <div class="text-sm">Supprimer tout le dataset</div>
    </button>
    
    <button 
      @click="showUploadModal = true"
      :disabled="loading"
      class="p-4 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
    >
      <div class="text-lg font-semibold">Upload Dataset</div>
      <div class="text-sm">Ajouter de nouvelles données</div>
    </button>
    
    <button 
      @click="processDataset()"
      :disabled="loading || !(datasetStatus.raw_data && datasetStatus.raw_data.exists)"
      class="p-4 bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed"
    >
      <div class="text-lg font-semibold">Traiter</div>
      <div class="text-sm">Nettoyer et convertir</div>
    </button>
    
    <button 
      @click="showTrainModal = true"
      :disabled="loading || !(datasetStatus.yolo_dataset && datasetStatus.yolo_dataset.exists)"
      class="p-4 bg-purple-500 text-white rounded hover:bg-purple-600 disabled:opacity-50 disabled:cursor-not-allowed"
    >
      <div class="text-lg font-semibold">Entraîner</div>
      <div class="text-sm">Créer un nouveau modèle</div>
    </button>
  </div>

  <!-- Logs d'Activité -->
  <div class="bg-white dark:bg-gray-800 rounded shadow p-4 text-gray-900 dark:text-gray-100 border border-gray-200 dark:border-gray-700">
    <h2 class="text-lg font-semibold mb-3">Logs d'Activité</h2>
    <div class="bg-gray-100 dark:bg-gray-900 p-3 rounded font-mono text-sm max-h-64 overflow-y-auto">
      <template x-for="log in logs" :key="log.id">
        <div class="mb-1">
          <span class="text-gray-500" x-text="log.timestamp"></span>
          <span :class="log.type === 'error' ? 'text-red-600' : log.type === 'success' ? 'text-green-600' : 'text-blue-600'" x-text="log.message"></span>
        </div>
      </template>
    </div>
  </div>

  <!-- Modal Upload Dataset -->
  <div x-show="showUploadModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto text-gray-900 dark:text-gray-100 border border-gray-200 dark:border-gray-700">
      <h3 class="text-xl font-semibold mb-4">Upload Dataset</h3>
      
      <form @submit.prevent="uploadDataset()" enctype="multipart/form-data">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Images d'Entraînement</label>
            <input 
              type="file" 
              multiple 
              accept="image/*"
              @change="handleFileSelect($event, 'trainImages')"
              class="w-full p-2 border rounded"
            >
            <div class="text-sm text-gray-500 dark:text-gray-400" x-text="`${trainImages.length} fichiers sélectionnés`"></div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Images de Test</label>
            <input 
              type="file" 
              multiple 
              accept="image/*"
              @change="handleFileSelect($event, 'testImages')"
              class="w-full p-2 border rounded"
            >
            <div class="text-sm text-gray-500 dark:text-gray-400" x-text="`${testImages.length} fichiers sélectionnés`"></div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Annotations d'Entraînement (CSV)</label>
            <input 
              type="file" 
              accept=".csv"
              @change="handleFileSelect($event, 'trainAnnotations')"
              class="w-full p-2 border rounded"
            >
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Annotations de Test (CSV)</label>
            <input 
              type="file" 
              accept=".csv"
              @change="handleFileSelect($event, 'testAnnotations')"
              class="w-full p-2 border rounded"
            >
          </div>
        </div>
        
        <div class="flex justify-end space-x-3 mt-6">
          <button 
            type="button" 
            @click="showUploadModal = false"
            class="px-4 py-2 bg-gray-300 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded hover:bg-gray-400 dark:hover:bg-gray-600"
          >
            Annuler
          </button>
          <button 
            type="submit"
            :disabled="loading || trainImages.length === 0 || testImages.length === 0"
            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50"
          >
            Upload
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Entraînement -->
  <div x-show="showTrainModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md text-gray-900 dark:text-gray-100 border border-gray-200 dark:border-gray-700">
      <h3 class="text-xl font-semibold mb-4">Entraîner le Modèle</h3>
      
      <form @submit.prevent="trainModel()">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nombre d'Époques</label>
            <input 
              type="number" 
              x-model="trainParams.epochs"
              min="1" 
              max="1000" 
              class="w-full p-2 border rounded"
            >
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Taille du Batch</label>
            <input 
              type="number" 
              x-model="trainParams.batchSize"
              min="1" 
              max="64" 
              class="w-full p-2 border rounded"
            >
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Taille des Images</label>
            <input 
              type="number" 
              x-model="trainParams.imageSize"
              min="320" 
              max="1280" 
              step="32"
              class="w-full p-2 border rounded"
            >
          </div>
        </div>
        
        <div class="flex justify-end space-x-3 mt-6">
          <button 
            type="button" 
            @click="showTrainModal = false"
            class="px-4 py-2 bg-gray-300 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded hover:bg-gray-400 dark:hover:bg-gray-600"
          >
            Annuler
          </button>
          <button 
            type="submit"
            :disabled="loading"
            class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 disabled:opacity-50"
          >
            Entraîner
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function datasetManager() {
  return {
    loading: false,
    showUploadModal: false,
    showTrainModal: false,
    logs: [],
    datasetStatus: {
      raw_data: { exists: false, train_images: 0, test_images: 0 },
      cleaned_data: { exists: false, train_images: 0, test_images: 0 },
      yolo_dataset: { exists: false, train_images: 0, val_images: 0, test_images: 0 },
      model: { exists: false, path: '' }
    },
    trainImages: [],
    testImages: [],
    trainAnnotations: null,
    testAnnotations: null,
    trainParams: {
      epochs: 50,
      batchSize: 16,
      imageSize: 640
    },

    init() {
      this.loadDatasetStatus();
      this.addLog('info', 'Interface de gestion du dataset initialisée');
    },

    async loadDatasetStatus() {
      try {
        const response = await fetch('/admin/dataset/status', {
          headers: this._authHeaders()
        });
        const data = await response.json();
        this.datasetStatus = data;
        this.addLog('info', 'Statut du dataset mis à jour');
      } catch (error) {
        this.addLog('error', 'Erreur lors du chargement du statut: ' + error.message);
      }
    },

    async resetDataset() {
      if (!confirm('Êtes-vous sûr de vouloir réinitialiser complètement le dataset ? Cette action est irréversible.')) {
        return;
      }

      this.loading = true;
      this.addLog('info', 'Réinitialisation du dataset...');

      try {
        const response = await fetch('/admin/dataset/reset', { method: 'POST', headers: this._authHeaders() });
        const data = await response.json();
        
        if (response.ok) {
          this.addLog('success', 'Dataset réinitialisé avec succès');
          await this.loadDatasetStatus();
        } else {
          this.addLog('error', 'Erreur: ' + data.detail);
        }
      } catch (error) {
        this.addLog('error', 'Erreur lors de la réinitialisation: ' + error.message);
      } finally {
        this.loading = false;
      }
    },

    async processDataset() {
      this.loading = true;
      this.addLog('info', 'Traitement du dataset...');

      try {
        const response = await fetch('/admin/dataset/process', { method: 'POST', headers: this._authHeaders() });
        const data = await response.json();
        
        if (response.ok) {
          this.addLog('success', 'Dataset traité avec succès');
          await this.loadDatasetStatus();
        } else {
          this.addLog('error', 'Erreur: ' + data.detail);
        }
      } catch (error) {
        this.addLog('error', 'Erreur lors du traitement: ' + error.message);
      } finally {
        this.loading = false;
      }
    },

    async trainModel() {
      this.loading = true;
      this.addLog('info', `Entraînement du modèle: ${this.trainParams.epochs} époques...`);

      try {
        const params = new URLSearchParams({
          epochs: this.trainParams.epochs,
          batch_size: this.trainParams.batchSize,
          image_size: this.trainParams.imageSize
        });

        const response = await fetch(`/admin/dataset/train?${params}`, { method: 'POST', headers: this._authHeaders() });
        const data = await response.json();
        
        if (response.ok) {
          this.addLog('success', 'Modèle entraîné avec succès');
          await this.loadDatasetStatus();
          this.showTrainModal = false;
        } else {
          this.addLog('error', 'Erreur: ' + data.detail);
        }
      } catch (error) {
        this.addLog('error', 'Erreur lors de l\'entraînement: ' + error.message);
      } finally {
        this.loading = false;
      }
    },

    async uploadDataset() {
      if (this.trainImages.length === 0 || this.testImages.length === 0) {
        this.addLog('error', 'Veuillez sélectionner des images d\'entraînement et de test');
        return;
      }

      this.loading = true;
      this.addLog('info', 'Upload du dataset...');

      try {
        const formData = new FormData();
        
        // Ajouter les images d'entraînement
        this.trainImages.forEach(file => {
          formData.append('train_images', file);
        });
        
        // Ajouter les images de test
        this.testImages.forEach(file => {
          formData.append('test_images', file);
        });
        
        // Ajouter les annotations
        if (this.trainAnnotations) {
          formData.append('train_annotations', this.trainAnnotations);
        }
        if (this.testAnnotations) {
          formData.append('test_annotations', this.testAnnotations);
        }

        const response = await fetch('/admin/dataset/upload', {
          method: 'POST',
          headers: this._authHeaders(),
          body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
          this.addLog('success', `Dataset uploadé: ${data.train_images} train, ${data.test_images} test`);
          await this.loadDatasetStatus();
          this.showUploadModal = false;
          this.resetUploadForm();
        } else {
          this.addLog('error', 'Erreur: ' + data.detail);
        }
      } catch (error) {
        this.addLog('error', 'Erreur lors de l\'upload: ' + error.message);
      } finally {
        this.loading = false;
      }
    },

    handleFileSelect(event, type) {
      const files = Array.from(event.target.files);
      
      if (type === 'trainImages' || type === 'testImages') {
        this[type] = files;
      } else {
        this[type] = files[0] || null;
      }
    },

    resetUploadForm() {
      this.trainImages = [];
      this.testImages = [];
      this.trainAnnotations = null;
      this.testAnnotations = null;
    },

    addLog(type, message) {
      this.logs.unshift({
        id: Date.now(),
        timestamp: new Date().toLocaleTimeString(),
        type: type,
        message: message
      });
      
      // Limiter à 100 logs
      if (this.logs.length > 100) {
        this.logs = this.logs.slice(0, 100);
      }
    }
    ,
    _authHeaders() {
      const token = localStorage.getItem('plant_ai_token') || '';
      return token ? { 'Authorization': `Bearer ${token}` } : {};
    }
  }
}
</script>
{% endblock %}



